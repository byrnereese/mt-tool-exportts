#!/usr/bin/perl -w
#
# Movable Type (r) (C) 2001-2008 Six Apart, Ltd. All Rights Reserved.
# (C) 2009-2010 Endevver, LLC. All Rights Reserved.
#
# This software is licensed under the GPLv2.
#
# Author:       Byrne Reese <byrne at majordojo dot com>
# Changes by:   Jay Allen <jay at endevver dot com>
#
package MT::Tool::ExportTemplateSet;
use strict;
use warnings;
use Carp;

use lib qw( lib extlib );
use base qw( MT::Tool );

sub usage {
    return qq{--blog=<blog_id> --name=<TS name> [--version=<TS version>]
        [--id=<TS ID>] [--key=<TS key>] [--static=<dir>]};
}

sub help {
    return qq{
        export-ts - A tool to export a blog's templates as a template set

        --blog      The Blog ID of a specific blog to export templates
                    from. (optional)

        --name      The name to be used for the creation of the resulting
                    plugin. This is also used to determine the output
                    directory for related files.

        --version   The version string to be used for the creation of
                    the resulting plugin. (optional)

        --static    The path to the directory containing your mt-static
                    files for this template set. It must be a relative 
                    path from your mt-static folder.

        --id        The ID of the resulting template set. (optional)

        --key       The key of the resulting template set. (optional)

        --verbose   Show verbose messages.
};
}

my ( $BLOG_ID,      $TS_NAME, $TS_ID,       $TS_KEY,    $DRYRUN,
     $TS_VERSION,   $VERBOSE, $BASE_DIR,    $STATIC,    %blog_id, $fmgr);
$TS_NAME    = 'My Template Set';
$TS_VERSION = '1.0';

sub options {
    return (
        'blog=i'    => \$BLOG_ID,
        'name=s'    => \$TS_NAME,
        'static=s'  => \$STATIC,
        'id=s'      => \$TS_ID,
        'key=s'     => \$TS_KEY,
        'version=s' => \$TS_VERSION,
        'dryrun'    => \$DRYRUN,
    );
}

use lib './lib';
use MT::Theme::Exporter;

sub main {
    my $class = shift;
    $VERBOSE = $class->SUPER::main(@_);
    $class->show_usage() && exit if (! defined $BLOG_ID) || !$TS_NAME;

    my $blog;
    my %options;
    if ($BLOG_ID) {
        $blog = MT->model('blog')->load( $BLOG_ID );
        $options{'pack_name'} = $blog->name . ' Theme Pack';
    }

    my $id     = $TS_ID;
    my $key    = $TS_KEY;
    my $name   = $TS_NAME;
    my $static = $STATIC;
    
    $id     ||= MT::Util::dirify($TS_NAME);
    $key    ||= MT::Util::dirify($TS_NAME);
    $static ||= File::Spec->catdir( 'plugins', $TS_KEY );

    my $exporter = MT::Theme::Exporter->new({
        %options,
        logger       => sub { print STDERR $_[0] },
        key          => $TS_KEY, 
        pack_version => $TS_VERSION,
        verbose      => $VERBOSE,
        dryrun       => $DRYRUN
    });

    # Shorthand convenience variable
    %blog_id = (blog_id => $BLOG_ID);

    # No use doing a dry run if we can't see what's happening
    $VERBOSE = $DRYRUN if $DRYRUN;
    
    $exporter->export({
        blog_id => $BLOG_ID,
        name    => $name,
        static  => $static,
    });

    $exporter->write();
}

__PACKAGE__->main() unless caller;

1;
__END__

=head1 NAME

export-ts - A tool to export a blog's templates as a template set

=head1 SYNOPSIS

    cd /path/to/cgi-bin/mt
    perl ./tools/export_ts -blog=1 -key="MyTemplateSet"

=head1 INSTALLATION

Place this script inside your Movable Type "tools" directory.

=head1 DESCRIPTION

I<export-ts> is a tool to export a blog's templates to a
template set that can easily be install elsewhere.

=head1 OPTIONS

The following options are available:

  --blog      The Blog ID to export templates from
  
  --key       The key to be used for the creation of the
              resulting plugin. This is also used to determine
              the output directory for related files.

=head1 USAGE

From the command line, one would type:

    prompt> chmod a+x export-ts
    prompt> MT_HOME=/path/to/mt export-ts --blog=<id> \
            --key=MySet --name="My Template Set"

This would result in the following directories being created:

=over 4

=item * MySet/plugins/MySet/config.yaml

=item * MySet/plugins/MySet/templates/*

=item * MySet/mt-static/plugins/MySet/*

=back

You should then be able to zip up the MySet directory or simply install its
contents into MT_HOME as you would any other plugin.

=cut
